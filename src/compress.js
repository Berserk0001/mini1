import r from"sharp";import o from"./redirect.js";r.cache(false);r.concurrency(1);export default function compress(t,s,e){const i="jpeg";e.pipe(r().grayscale(t.params.grayscale).toFormat(i,{quality:t.params.quality}).toBuffer((e,r,a)=>{if(e||!a){o(t,s);return}s.setHeader("content-type","image/"+i);s.setHeader("content-length",a.size);s.setHeader("x-original-size",t.params.originSize);s.setHeader("x-bytes-saved",t.params.originSize-a.size);s.status(200);s.write(r);s.end()}))}
